name: Tag Version After Merge

on:
  pull_request:
    types: [closed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.job.name}}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  tag:
    name: Create Version Tag
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate GitHub App Token
        id: github_app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.TECHPRIMATE_RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.TECHPRIMATE_RELEASE_BOT_PRIVATE_KEY }}

      - name: Configure Git
        run: |
          git config user.name "techprimate-release-bot"
          git config user.email "techprimate-release-bot@users.noreply.github.com"

      - name: Extract Version and Build from Commit Message
        id: extract_version
        run: |
          # Get the merge commit message
          COMMIT_MESSAGE=$(git log -1 --format=%B ${{ github.event.pull_request.merge_commit_sha }})

          echo "Commit message:"
          echo "$COMMIT_MESSAGE"
          echo ""

          # Extract directive from commit message body
          DIRECTIVE=$(echo "$COMMIT_MESSAGE" | grep -E "^action=bump,version=[0-9]+\.[0-9]+\.[0-9]+,build=[0-9]+$" || echo "")

          if [ -z "$DIRECTIVE" ]; then
            echo "❌ Error: Could not find structured directive in commit message"
            echo "Expected format: action=bump,version=X.Y.Z,build=N"
            exit 1
          fi

          # Parse version and build from directive
          VERSION=$(echo "$DIRECTIVE" | sed -n 's/.*version=\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          BUILD=$(echo "$DIRECTIVE" | sed -n 's/.*build=\([0-9]\+\).*/\1/p')

          if [ -z "$VERSION" ] || [ -z "$BUILD" ]; then
            echo "❌ Error: Could not parse version or build from directive: $DIRECTIVE"
            exit 1
          fi

          echo "✅ Parsed version: $VERSION"
          echo "✅ Parsed build: $BUILD"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}+${BUILD}" >> $GITHUB_OUTPUT

      - name: Create and Push Tag
        env:
          GITHUB_TOKEN: ${{ steps.github_app_token.outputs.token }}
        run: |
          TAG="${{ steps.extract_version.outputs.tag }}"
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"

          echo "Creating tag $TAG on commit $MERGE_SHA"

          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "⚠️ Tag $TAG already exists, skipping creation"
            exit 0
          fi

          # Create tag on the merged commit
          git tag -a "$TAG" -m "Release $TAG" "$MERGE_SHA"

          # Push tag to remote
          git push origin "$TAG"

          echo "✅ Tag $TAG created and pushed successfully"
