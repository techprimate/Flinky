default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Get version info to match what the app uses
    version_number = get_version_number(xcodeproj: "Flinky.xcodeproj")
    
    # Increment build number before building
    increment_build_number(xcodeproj: "Flinky.xcodeproj")
    build_number = get_build_number(xcodeproj: "Flinky.xcodeproj")
    
    # Create Sentry release using the same format as the app
    sentry_create_release(
      auth_token: ENV["SENTRY_AUTH_TOKEN"],
      org_slug: "techprimate",
      project_slug: "flinky",

      app_identifier: "com.techprimate.Flinky",
      version: version_number
    )
    
    # Build the app
    build_app(scheme: "Flinky")
    
    # Upload debug symbols to Sentry
    sentry_debug_files_upload(
      auth_token: ENV["SENTRY_AUTH_TOKEN"],
      org_slug: "techprimate",
      project_slug: "flinky",
      
      # Wait for the server to fully process uploaded files. Errors
      # can only be displayed if --wait is specified, but this will
      # significantly slow down the upload process
      wait: true
    )
    
    # Associate commits with the release
    sentry_set_commits(
      auth_token: ENV["SENTRY_AUTH_TOKEN"],
      org_slug: "techprimate",
      project_slug: "flinky",

      app_identifier: "com.techprimate.Flinky",
      version: version_number,
      build: build_number,
      auto: true
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      # API Key file must be located at fastlane/api-key.json
      api_key_path: File.expand_path("./api-key.json"),
      app_version: version_number,
      build_number: build_number,
      # distribute_external: true,
      # groups: ["Friends At Sentry"]
    )
    
    # Finalize the Sentry release after successful upload
    sentry_finalize_release(
      auth_token: ENV["SENTRY_AUTH_TOKEN"],
      org_slug: "techprimate",
      project_slug: "flinky",

      app_identifier: "com.techprimate.Flinky",
      version: version_number,
      build: build_number
    )
   
    # Create version tag
    version_tag = "v#{version_number}+#{build_number}"
    
    # Commit the version changes (project.pbxproj and Root.plist are updated by build scripts)
    git_add(path: ["Flinky.xcodeproj/project.pbxproj", "Sources/Resources/Settings.bundle/Root.plist"])
    git_commit(
      path: ["Flinky.xcodeproj/project.pbxproj", "Sources/Resources/Settings.bundle/Root.plist"],
      message: "chore: Bump version to #{version_number} (#{build_number})"
    )
    
    # Create git tag for this version
    add_git_tag(tag: version_tag)
     
    # Push the commit and tag to remote
    push_to_git_remote(
      remote: 'origin',
      local_branch: version_tag,
    )
  end
end
